---
title: "SimpleLoginのホストを諦めた"
date: 2023-07-17T09:00:00+09:00
draft: false
pinned: true
#featured_image: eyecatch/simplelogin.png
tags:
- simplelogin
---
SimpleLoginという、自分のメールアドレスを秘匿してメールを受信/送信するサービスがあります。ほしかったのでホストしようと思ってたんだけど宗教上の理由でやめることにした。この記事は導入のメモと勉強した内容、導入をやめた理由を書いています。あんまり人の役に立たないかもしれない。
<!--more-->

## SimpleLoginとは
自分のアドレス「hoge@fuga.com」があるとします。これを使って色んなサイトに登録することは出来るけど、
- 変なメルマガが寄越されたり
- 登録解除が出来ない
- 情報として残されたくない
- 別にサービス利用したいだけでわざわざ情報を献上したくない
- メアドが割れたら色んなサイトに登録しているかばれてしまう
等様々な懸念があると思います。

SimpleLoginを使えば、サイト毎に捨てアドレスを発行し、その捨てアドレスに来たメールを自分のhoge@fuga.comに流すことができます。  
一応、世の中には既にそういう従来研究があり、捨てアドレスを一時的に発行するといったサービスは沢山あります。が、それらは一時的にしか使えなかったり、捨てアドレスを発行したサイトなりツールをいちいち開かなくてはなりません。またそもそも捨てアドレスには登録自体させないみたいなものもあります。

SimpleLoginを使うと、自分のメールアドレスさえ開いておけば大量の捨てアドレスに届いたメールを一括で見ることができるわけです。便利ですね。

え？捨てアドレスに沢山メルマガとかスパムとか来たらうざくね？と思ったりしますが、SimpleLoginは発行したアドレス単位でフィルタリング出来るので「このサイトに登録したアドレスにすごいメルマガ/スパムくるな」となったらそのアドレス宛のメールをメインのアドレスに転送するのを辞めるなどが出来るわけです。

今まで受信の話だけしてきましたが、捨てアドレス名義で送信することも可能。たまに登録したアドレスで送信しないと認証できないとか、手続きが進められないサービスに対しても対応することが出来るわけです。

## simpleloginのセルフホスト
SearXNGみたいにインスタンスの概念があるわけではないですが、このサービスも一応無料で利用することは出来ます。が、無料では機能制限があり、全く使えないわけではないけど使い勝手が悪いわけです。そこで、simpleloginをセルフホストしてしまえば無料でプレミアムユーザ同様の機能が使えるのでホストするか。ということに。

simpleLoginのセルフホスト手順は[こちら](https://github.com/simple-login/app)  
メールサーバを建てることとほぼほぼ同義なので、DNS/メールサーバのお勉強をしながらちょいちょい作業していけばOKという感じです。dockerやpostgresqlに詳しい人ならもっと早く終わりそう。

## セルフホストで詰まったことの備忘録1
dkim秘密鍵の生成で詰まる。この[issue](https://github.com/simple-login/app/discussions/1037)読んで救われる人は多そう

## セルフホストで詰まったことの備忘録2
dockerに慣れている人は気にならないと思うが、postgresqlもdockerで済ませるか自前で用意しているものを使うかで若干手順が変わる。  

前者はインストールガイドに書いてあるママやればいいので割愛するが、後者の場合docker環境ファイルのDB_URIをsl-dbでなくサーバのIPにする(これは当たり前だが。)、pg_hba.confでdocker環境からアクセスできるようにするなど必要。  

confには例えばこんなふうに書く。自分はデータベースに明るくなく、ちょっと詰まった。
```bash
host    simplelogin    user          10.0.0.0/24             md5
```

## セルフホストで詰まったことの備忘録3
なんか上手く行かないときにログどこ見ればいいかわからん問題。simplelogin本体系は
```bash
$ docker ps 
```
で得たプロセスについて
```bash
$ docker logs [プロセス]
```
見れば良くて、postfixは/var/log/mail.logを見ればエラーが書いてある。

## セルフホストできたけどなんか上手く行かない
3時間くらい掛けてなんとかsimpleloginをホストしたものの、登録の際の認証メールが送信されない。/var/log/mail.logを見てもタイムアウトとしか書かれてなく、dockerのプロセスもエラーなし。postfixを疑いswakでメールを送れるか確認しても上手く行かない。

色々試したところ、telnetで25はだめだが587で接続できることを確認してやっと原因がわかった。25番ポートがISPにブロックされているのが原因。そもそも何故25ポートがブロックされているのか調べたところ、OP25B(Outbound Port 25 Blocking)と呼ばれるものらしい。

簡単に説明すると25ポートを使用して行うSMTPにユーザ認証機能がなく、誰でも大量のメールを送れてしまうため25番を塞いだろという一般的に行われる施策のようなものらしい。多分僕が個別に問い合わせしても特別に開けてくれる...なんてことはなさそう。

OP25Bの回避策として、googleやsendgridにSMTP転送してもらうという手口があるらしいが、僕のそもそもの目的はサードパーティにメールを管理されたくなくて全て自分の手で持ちたいということなのでこれらを使って回避は出来ない。そういうわけで諦めることになった。 [参考](https://github.com/simple-login/app/blob/master/docs/gmail-relay.md)

## 最後に
そういうことで諦めました。まあ色々勉強できたし、何はともあれ一旦はセルフホストしたいもの全部に手を出し切れたのでよかった。

一応dockerのコンテナは保持しておくので、今後進展があったら自分でまた作業してみます。
